---
interface Props {
    data: { label: string; value: number; color: string }[];
    variant?: "clean" | "hand-drawn";
}

const { data, variant = "clean" } = Astro.props;

const total = data.reduce((sum, item) => sum + item.value, 0);
let currentAngle = 0;

// Calculate slice paths
const slices = data.map((item) => {
    const angle = (item.value / total) * 360;
    const startAngle = currentAngle;
    const endAngle = currentAngle + angle;
    currentAngle += angle;

    // SVG Path calculation
    // Start from top (0, -1) relative to center
    const x1 = Math.cos(((startAngle - 90) * Math.PI) / 180);
    const y1 = Math.sin(((startAngle - 90) * Math.PI) / 180);
    const x2 = Math.cos(((endAngle - 90) * Math.PI) / 180);
    const y2 = Math.sin(((endAngle - 90) * Math.PI) / 180);

    // Large arc flag
    const largeArc = angle > 180 ? 1 : 0;

    const d = `M 0 0 L ${x1} ${y1} A 1 1 0 ${largeArc} 1 ${x2} ${y2} Z`;

    return { ...item, d, centerAngle: startAngle + angle / 2 };
});
---

<div class="w-full my-12 flex flex-col items-center">
    <div class="relative w-64 h-64 md:w-80 md:h-80">
        <svg viewBox="-1.2 -1.2 2.4 2.4" class="w-full h-full rotate-[-90deg]">
            {
                slices.map((slice, i) => (
                    <path
                        d={slice.d}
                        fill={slice.color}
                        stroke="white"
                        stroke-width={
                            variant === "hand-drawn" ? "0.02" : "0.01"
                        }
                        class={`origin-center transition-transform hover:scale-105 duration-300 ${variant === "hand-drawn" ? "rough-slice" : ""}`}
                        style={`filter: ${variant === "hand-drawn" ? "url(#rough-pie)" : "none"}; animation: scaleIn 0.5s ease-out backwards; animation-delay: ${i * 0.1}s;`}
                    />
                ))
            }

            {
                variant === "hand-drawn" && (
                    <defs>
                        <filter id="rough-pie">
                            <feTurbulence
                                type="fractalNoise"
                                baseFrequency="0.03"
                                numOctaves="3"
                                result="noise"
                            />
                            <feDisplacementMap
                                in="SourceGraphic"
                                in2="noise"
                                scale="0.05"
                            />
                        </filter>
                    </defs>
                )
            }
        </svg>

        {/* Labels Overlay */}
        <div class="absolute inset-0 pointer-events-none">
            {
                slices.map((slice) => {
                    // Position text based on angle
                    const rad = ((slice.centerAngle - 90) * Math.PI) / 180;
                    const r = 40; // distance % from center
                    const left = 50 + Math.cos(rad) * 25 + "%";
                    const top = 50 + Math.sin(rad) * 25 + "%";

                    return (
                        <div
                            class="absolute text-white font-bold text-sm md:text-base drop-shadow-md transform -translate-x-1/2 -translate-y-1/2"
                            style={{ left, top }}
                        >
                            {Math.round((slice.value / total) * 100)}%
                        </div>
                    );
                })
            }
        </div>
    </div>

    {/* Legend */}
    <div class="flex flex-wrap justify-center gap-6 mt-8">
        {
            data.map((item) => (
                <div class="flex items-center gap-2">
                    <div
                        class="w-3 h-3 rounded-full"
                        style={`background-color: ${item.color}`}
                    />
                    <span class="text-sm font-medium text-slate-700">
                        {item.label}
                    </span>
                </div>
            ))
        }
    </div>
</div>

<style>
    @keyframes scaleIn {
        from {
            transform: scale(0);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>
