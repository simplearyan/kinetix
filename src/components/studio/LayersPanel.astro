---

---

<div class="flex-1 overflow-y-auto p-2" id="layers-panel">
    <div class="text-xs text-gray-500 text-center py-4">No layers</div>
</div>

<script>
    import { selectedObjectId } from "../../stores/studioStore";

    const panel = document.getElementById("layers-panel")!;
    let currentObjects: any[] = [];

    // --- Listeners ---

    function setupListeners() {
        if (!(window as any).studioEngine) return;

        // 1. Engine updates list
        (window as any).studioEngine.onObjectListChange = (objects: any[]) => {
            currentObjects = objects; // Keep ref
            renderLayers();
        };

        // Initial fetch
        currentObjects = (window as any).studioEngine.objects;
        renderLayers();
    }

    if ((window as any).studioEngine) {
        setupListeners();
    } else {
        window.addEventListener("studio:ready", setupListeners);
    }

    // 2. Selection changes (update highlight)
    selectedObjectId.subscribe((id) => {
        renderLayers();
    });

    // Helper to render
    function renderLayers() {
        if (!currentObjects || currentObjects.length === 0) {
            panel.innerHTML = `<div class="text-xs text-gray-500 text-center py-4">No layers found</div>`;
            return;
        }

        const currentSel = selectedObjectId.get();

        // Reverse to show top-most first
        const reversed = [...currentObjects].reverse();

        let html = `<ul class="space-y-1">`;
        reversed.forEach((obj) => {
            const isSel = obj.id === currentSel;
            // Simple SVGs
            const iconSvg =
                obj.type === "text"
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>`;

            const displayName = obj.name || obj.id;

            html += `
                <li class="group flex items-center justify-between px-3 py-2.5 rounded-lg cursor-pointer transition-all border ${isSel ? "bg-blue-50 border-blue-200 dark:bg-blue-900/20 dark:border-blue-500/30" : "bg-white dark:bg-gray-800 border-transparent hover:border-gray-200 dark:hover:border-gray-700"}"
                    data-id="${obj.id}"
                >
                    <div class="flex items-center gap-3 overflow-hidden flex-1">
                        <span class="flex items-center justify-center text-gray-400 ${isSel ? "text-blue-500" : ""}">
                            ${iconSvg}
                        </span>
                        <span class="text-xs font-medium ${isSel ? "text-blue-700 dark:text-blue-300" : "text-gray-600 dark:text-gray-300"} truncate select-none flex-1" title="${displayName}">
                            ${displayName}
                        </span>
                    </div>

                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                         <!-- Rename -->
                        <button class="action-btn rename-layer p-1 text-gray-400 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded"
                            title="Rename" data-id="${obj.id}" data-name="${displayName}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>

                        <!-- Duplicate -->
                        <button class="action-btn duplicate-layer p-1 text-gray-400 hover:text-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded"
                            title="Duplicate" data-id="${obj.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                        </button>

                        <!-- Delete -->
                        <button class="action-btn delete-layer p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded"
                            title="Delete" data-id="${obj.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>
                    </div>
                </li>
            `;
        });
        html += `</ul>`;

        panel.innerHTML = html;

        // Bind clicks
        panel.querySelectorAll("li").forEach((li) => {
            li.addEventListener("click", (e) => {
                // Ignore action button clicks
                if ((e.target as HTMLElement).closest(".action-btn")) return;

                const id = li.dataset.id;
                (window as any).studioEngine.selectObject(id);
            });
        });

        // Delete
        panel.querySelectorAll(".delete-layer").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                const id = (btn as HTMLElement).dataset.id;
                (window as any).studioEngine.removeObject(id);
            });
        });

        // Duplicate
        panel.querySelectorAll(".duplicate-layer").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                const id = (btn as HTMLElement).dataset.id;
                (window as any).studioEngine.duplicateObject(id);
            });
        });

        // Rename
        panel.querySelectorAll(".rename-layer").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                const id = (btn as HTMLElement).dataset.id!;
                const currentName = (btn as HTMLElement).dataset.name!;

                const newName = prompt("Rename layer:", currentName);
                if (newName && newName.trim() !== "") {
                    (window as any).studioEngine.renameObject(
                        id,
                        newName.trim(),
                    );
                }
            });
        });
    }
</script>
