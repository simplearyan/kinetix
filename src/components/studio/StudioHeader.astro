---

---

<!-- Toolbar (Header) -->
<div
    class="h-14 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-2 sm:px-4 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm relative z-30 shrink-0 gap-2"
>
    <!-- Left: Home & File Info -->
    <div class="flex items-center gap-2 sm:gap-3 shrink-0">
        <a
            href="/"
            class="p-2 -ml-2 text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors"
            title="Home"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"
                ></path><polyline points="9 22 9 12 15 12 15 22"
                ></polyline></svg
            >
        </a>
        <div class="h-6 w-px bg-gray-200 dark:bg-gray-800 hidden sm:block">
        </div>
        <div class="flex flex-col">
            <input
                type="text"
                value="Untitled Project"
                class="bg-transparent font-semibold text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 rounded px-1 -ml-1 w-32 sm:w-48 transition-all truncate"
            />
            <span class="text-[10px] text-gray-400 px-1 hidden sm:inline"
                >Cloud â€¢ Saved</span
            >
        </div>
    </div>

    <!-- Center: Canvas Settings (Responsive) -->
    <div class="flex items-center gap-2 mx-auto">
        <!-- Resolution -->
        <div
            class="flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 transition-colors group relative"
        >
            <select
                id="header-resolution"
                class="appearance-none bg-transparent text-xs font-medium focus:outline-none cursor-pointer pr-4 text-center max-w-[80px] sm:max-w-none"
            >
                <option value="854x480">480p</option>
                <option value="1280x720">720p</option>
                <option value="1920x1080" selected>1080p</option>
                <option value="3840x2160">4K</option>
            </select>
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-200"
                ><path d="m6 9 6 6 6-6"></path></svg
            >
        </div>

        <div class="h-4 w-px bg-gray-200 dark:bg-gray-800 hidden sm:block">
        </div>

        <!-- Background Color -->
        <div class="relative group">
            <input
                type="color"
                id="header-bgcolor"
                value="#111827"
                class="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10"
            />
            <div
                class="flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors cursor-pointer"
            >
                <div
                    id="header-bgcolor-preview"
                    class="w-4 h-4 rounded-full border border-gray-200 dark:border-gray-700 shadow-sm"
                    style="background-color: #111827;"
                >
                </div>
                <span
                    class="text-xs font-medium text-gray-600 dark:text-gray-300 hidden sm:inline"
                    >Bg</span
                >
            </div>
        </div>
    </div>

    <!-- Right: Export & Share -->
    <div class="flex items-center gap-2 sm:gap-3 shrink-0">
        <div
            class="flex items-center gap-2 sm:gap-3 pr-2 sm:pr-3 border-r border-gray-200 dark:border-gray-800"
        >
            <div class="flex items-center gap-1.5">
                <span
                    class="text-[10px] font-bold text-gray-400 uppercase tracking-wider hidden md:inline"
                    >Duration</span
                >
                <div
                    class="flex items-center bg-gray-100 dark:bg-gray-800 rounded px-2 py-1"
                >
                    <input
                        type="number"
                        id="header-duration"
                        value="5"
                        class="w-6 sm:w-8 bg-transparent text-xs font-medium text-center focus:outline-none text-gray-900 dark:text-white"
                    />
                    <span class="text-[10px] text-gray-500">s</span>
                </div>
            </div>

            <div
                class="flex items-center bg-gray-100 dark:bg-gray-800 rounded px-2 py-1 hidden sm:flex"
            >
                <select
                    id="header-format"
                    class="bg-transparent text-xs font-medium focus:outline-none text-gray-900 dark:text-white cursor-pointer"
                >
                    <option value="video/webm">WebM</option>
                    <option value="video/mp4">MP4</option>
                </select>
            </div>
        </div>

        <button
            id="header-export-btn"
            class="px-3 py-1.5 bg-gray-900 dark:bg-white hover:bg-gray-800 dark:hover:bg-gray-100 text-white dark:text-gray-900 text-xs font-bold rounded shadow-sm hover:shadow flex items-center gap-2 transition-all active:scale-95"
        >
            <span class="hidden sm:inline">Export</span>
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                ></path><polyline points="7 10 12 15 17 10"></polyline><line
                    x1="12"
                    y1="15"
                    x2="12"
                    y2="3"></line></svg
            >
        </button>

        <!-- Sidebar Toggle (Mobile) -->
        <button
            id="toggle-sidebar"
            class="p-2 sm:hidden text-gray-500 rounded hover:bg-gray-100 dark:hover:bg-gray-800"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><rect width="18" height="18" x="3" y="3" rx="2" ry="2"
                ></rect><line x1="15" x2="15" y1="3" y2="21"></line></svg
            >
        </button>

        <!-- Hidden Progress Toast -->
        <div
            id="export-toast"
            class="hidden absolute top-16 right-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 p-4 rounded-xl shadow-2xl w-72 z-50 animate-fade-in"
        >
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-gray-900 dark:text-white"
                    >Exporting...</span
                >
                <span
                    id="toast-progress-val"
                    class="text-xs font-mono text-blue-600 dark:text-blue-400"
                    >0%</span
                >
            </div>
            <div
                class="h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden"
            >
                <div
                    id="toast-progress-bar"
                    class="h-full bg-blue-600 dark:bg-blue-500 w-0 transition-all duration-75"
                >
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function initHeader() {
        const engine = (window as any).studioEngine;
        if (!engine) {
            // Retry if engine not ready
            setTimeout(initHeader, 100);
            return;
        }

        // --- Export Logic ---
        const exportBtn = document.getElementById("header-export-btn");
        const durationInput = document.getElementById(
            "header-duration",
        ) as HTMLInputElement;
        const formatSelect = document.getElementById(
            "header-format",
        ) as HTMLSelectElement;

        // Filter unsupported formats
        if (formatSelect) {
            const mp4Option = formatSelect.querySelector(
                'option[value="video/mp4"]',
            ) as HTMLOptionElement;
            const webmOption = formatSelect.querySelector(
                'option[value="video/webm"]',
            ) as HTMLOptionElement;

            const supportsMp4 = MediaRecorder.isTypeSupported("video/mp4");
            const supportsWebM = MediaRecorder.isTypeSupported("video/webm");

            if (!supportsMp4 && mp4Option) {
                mp4Option.remove();
                if (formatSelect.value === "video/mp4")
                    formatSelect.value = "video/webm";
            }

            if (!supportsWebM && webmOption) {
                webmOption.remove();
            }
        }
        const toast = document.getElementById("export-toast");
        const toastBar = document.getElementById("toast-progress-bar");
        const toastVal = document.getElementById("toast-progress-val");

        // Set initial duration
        if (durationInput && engine) {
            durationInput.value = String(engine.totalDuration / 1000);
        }

        durationInput?.addEventListener("change", () => {
            if (engine)
                engine.totalDuration =
                    parseInt(durationInput.value || "5") * 1000;
        });

        exportBtn?.addEventListener("click", async () => {
            if (!engine) return;

            exportBtn.setAttribute("disabled", "true");
            exportBtn.classList.add("opacity-50", "cursor-not-allowed");
            toast?.classList.remove("hidden");

            try {
                let format = formatSelect ? formatSelect.value : "video/webm";
                console.log("Exporting with format:", format);

                const url = await engine.exportVideo({
                    fps: 60,
                    mimeType: format,
                    onProgress: (p: number) => {
                        if (toastBar && toastVal) {
                            const pct = Math.round(p * 100);
                            toastBar.style.width = `${pct}%`;
                            toastVal.textContent = `${pct}%`;
                        }
                    },
                });

                const a = document.createElement("a");
                a.href = url;
                const ext = format.includes("mp4") ? "mp4" : "webm";
                a.download = `kinetix-compose-${Date.now()}.${ext}`;
                a.click();
            } catch (e) {
                console.error(e);
                alert("Export Failed: " + (e as Error).message);
            } finally {
                exportBtn.removeAttribute("disabled");

                exportBtn.classList.remove("opacity-50", "cursor-not-allowed");
                setTimeout(() => {
                    toast?.classList.add("hidden");
                    if (toastBar) toastBar.style.width = "0%";
                }, 2000);
            }
        });

        // --- Background Color Logic ---
        const bgColorInput = document.getElementById(
            "header-bgcolor",
        ) as HTMLInputElement;
        const bgColorPreview = document.getElementById(
            "header-bgcolor-preview",
        );

        // Sync initial
        if (engine) {
            if (bgColorPreview)
                bgColorPreview.style.backgroundColor = engine.backgroundColor;
            if (bgColorInput) bgColorInput.value = engine.backgroundColor;
        }

        bgColorInput?.addEventListener("input", (e) => {
            const color = (e.target as HTMLInputElement).value;
            if (bgColorPreview) bgColorPreview.style.backgroundColor = color;
            if (engine) engine.setBackgroundColor(color);
        });

        // --- Sidebar Toggle ---
        const toggleSidebarBtn = document.getElementById("toggle-sidebar");
        const rightSidebar = document.getElementById("right-sidebar");

        toggleSidebarBtn?.addEventListener("click", () => {
            rightSidebar?.classList.toggle("translate-x-full");
        });
    }

    // Try to init when ready
    window.addEventListener("studio:ready", initHeader);
    // Also try immediately incase it was already ready
    if ((window as any).studioEngine) initHeader();
    // Fallback polling
    setTimeout(initHeader, 500);
</script>
