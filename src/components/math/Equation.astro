---
import katex from "katex";

interface Props {
    formula?: string;
    style?: "box" | "glass" | "neon" | "chalk" | "minimal";
    animate?: boolean;
    animationType?: "slide-up" | "fade-in" | "typewriter";
    class?: string;
}

const {
    formula = "",
    style = "minimal",
    animate = false,
    animationType = "slide-up",
    class: className,
} = Astro.props;

const html = formula
    ? katex.renderToString(formula, { throwOnError: false, displayMode: true })
    : "";

const styleClass = `eq-${style}`;
const animationClass = animate ? `animate-${animationType}` : "";
---

<div
    class={`equation-container ${styleClass} ${animationClass} ${className || ""}`}
>
    {formula ? <div set:html={html} /> : <slot />}
</div>

<script>
    const observerOptions = {
        root: null,
        rootMargin: "0px",
        threshold: 0.2,
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                entry.target.classList.add("in-view");
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    document.addEventListener("astro:page-load", () => {
        document
            .querySelectorAll('.equation-container[class*="animate-"]')
            .forEach((el) => {
                observer.observe(el);
            });
    });

    // Initial check
    document
        .querySelectorAll('.equation-container[class*="animate-"]')
        .forEach((el) => {
            observer.observe(el);
        });
</script>

<style>
    .equation-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        margin: 1.5rem 0;
        font-size: 1.2rem;
        position: relative;
        overflow-x: auto;
        transition: all 0.3s ease;
    }

    /* Styles */
    .eq-box {
        background: var(--color-bg-offset, #f3f4f6);
        border: 1px solid var(--color-border, #e5e7eb);
        border-radius: 8px;
    }

    .eq-glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .eq-neon {
        background: #111;
        color: #0f0;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
        border: 1px solid #0f0;
    }
    .eq-neon :global(.katex) {
        color: #0f0;
        text-shadow: 0 0 5px #0f0;
    }

    /* Chalk Styles */
    .eq-chalk,
    .eq-chalk-light,
    .eq-chalk-blue,
    .eq-chalk-green {
        font-family: "Kalam", cursive;
        border-radius: 4px;
        padding: 1.5rem;
    }

    .eq-chalk {
        background-color: #2b2b2b;
        color: #eee;
        border: 4px solid #5d4037;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .eq-chalk :global(.katex) {
        color: #fff;
        text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.2);
    }

    .eq-chalk-light {
        background-color: #fdfbf7;
        color: #2c3e50;
        border: 4px solid #dcdde1;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .eq-chalk-light :global(.katex) {
        color: #2c3e50;
    }

    .eq-chalk-blue {
        background-color: #1e3799;
        color: #fff;
        border: 4px solid #0c2461;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .eq-chalk-blue :global(.katex) {
        color: #fff;
    }

    .eq-chalk-green {
        background-color: #145a32;
        color: #f4d03f;
        border: 4px solid #0b5345;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .eq-chalk-green :global(.katex) {
        color: #f4d03f;
    }

    /* Notebook Style */
    .eq-notebook {
        background-color: #fef9e7;
        background-image: linear-gradient(#e5e7eb 1px, transparent 1px);
        background-size: 100% 1.5rem;
        color: #2c3e50;
        font-family: "Indie Flower", cursive;
        border-left: 4px solid #ef4444;
        padding: 1rem 2rem;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
    }
    .eq-notebook :global(.katex) {
        color: #2c3e50;
    }

    /* Animations */
    .animate-slide-up {
        opacity: 0;
        transform: translateY(20px);
    }
    .animate-slide-up.in-view {
        animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .animate-fade-in {
        opacity: 0;
    }
    .animate-fade-in.in-view {
        animation: fadeIn 0.8s ease-out forwards;
    }

    .animate-typewriter {
        overflow: hidden;
        white-space: nowrap;
        width: 0;
    }
    .animate-typewriter.in-view {
        animation: typing 2s steps(40, end) forwards;
    }

    @keyframes slideUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        to {
            opacity: 1;
        }
    }

    @keyframes typing {
        to {
            width: 100%;
        }
    }
</style>
