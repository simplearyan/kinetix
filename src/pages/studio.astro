---
import Layout from "../layouts/Layout.astro";
import StudioHeader from "../components/studio/StudioHeader.astro";
import StudioSidebar from "../components/studio/StudioSidebar.astro";
import PropertiesPanel from "../components/studio/PropertiesPanel.astro";
import LayersPanel from "../components/studio/LayersPanel.astro";
---

<Layout title="Kinetix Studio" showFooter={false} showAds={false}>
    <style>
        :global(body) {
            background-color: #0f172a !important; /* slate-900 */
            color: white !important;
            overflow: hidden;
        }

        /* Light Mode Native Support */
        :global(body.light-mode) {
            background-color: #f8fafc !important; /* slate-50 */
            color: #1e293b !important; /* slate-800 */
        }
    </style>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@100..900&family=Lobster&family=Merriweather:wght@300;400;700;900&family=Montserrat:wght@100..900&family=Oswald:wght@200..700&family=Pacifico&family=Playfair+Display:wght@400..900&family=Poppins:wght@100..900&family=Roboto+Mono:wght@100..700&display=swap"
        rel="stylesheet"
    />

    <div class="flex h-screen w-screen overflow-hidden">
        <!-- Sidebar (Slim Toolkit) -->
        <aside
            class="w-20 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 flex flex-col z-20 shadow-xl relative"
        >
            <!-- Logo Icon -->
            <div
                class="h-14 flex items-center justify-center border-b border-gray-200 dark:border-gray-800/50"
            >
                <div
                    class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white font-bold text-sm"
                >
                    K
                </div>
            </div>

            <!-- Tools -->
            <StudioSidebar />

            <!-- Bottom Actions -->
            <div
                class="mt-auto flex flex-col items-center gap-4 py-4 border-t border-gray-200 dark:border-gray-800/50"
            >
                <button
                    id="theme-toggle"
                    class="w-10 h-10 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400 flex items-center justify-center transition-colors"
                    title="Toggle Theme"
                >
                    <!-- Sun (Light Mode) -->
                    <svg
                        id="icon-sun"
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                        ></path>
                    </svg>
                    <!-- Moon (Dark Mode) -->
                    <svg
                        id="icon-moon"
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 hidden"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                        ></path>
                    </svg>
                </button>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main
            class="flex-1 flex flex-col bg-slate-100 dark:bg-gray-950 relative min-w-0"
        >
            <!-- Toolbar (Header) -->
            <StudioHeader />

            <!-- Canvas Area -->
            <div
                class="flex-1 overflow-auto flex items-center justify-center p-8 bg-[radial-gradient(#cbd5e1_1px,transparent_1px)] dark:bg-[radial-gradient(#1e293b_1px,transparent_1px)] [background-size:20px_20px] relative"
            >
                <div
                    class="relative shadow-2xl shadow-gray-200/50 dark:shadow-black/50 border border-gray-200 dark:border-gray-800 ring-1 ring-gray-200 dark:ring-gray-900/50 rounded-sm"
                >
                    <canvas
                        id="studio-canvas"
                        width="1920"
                        height="1080"
                        class="w-[800px] h-[450px] bg-white dark:bg-gray-900 block cursor-crosshair"
                    ></canvas>
                </div>

                <!-- Enhanced Timeline Controls (Floating) -->
                <div
                    class="absolute bottom-6 left-1/2 -translate-x-1/2 z-30 w-[600px] max-w-[90%] flex flex-col gap-2"
                >
                    <!-- Scrubber Bar -->
                    <div
                        class="relative w-full h-8 flex items-center group cursor-pointer"
                        id="timeline-container"
                    >
                        <!-- Track -->
                        <div
                            class="absolute w-full h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden pointer-events-none"
                        >
                            <!-- Progress -->
                            <div
                                id="timeline-progress"
                                class="h-full bg-blue-600/80 dark:bg-blue-500/80 w-0"
                            >
                            </div>
                        </div>

                        <!-- Hover Interaction Layer (Wider hit area) -->
                        <div class="absolute inset-0 z-10"></div>

                        <!-- Handle -->
                        <div
                            id="timeline-handle"
                            class="absolute h-4 w-4 bg-white border-2 border-blue-600 rounded-full shadow-md top-1/2 -translate-y-1/2 -translate-x-1/2 pointer-events-none transition-transform group-hover:scale-125 left-0"
                        >
                        </div>
                    </div>

                    <!-- Controls Row -->
                    <div
                        class="flex items-center justify-between bg-white/90 dark:bg-gray-800/90 backdrop-blur border border-gray-200 dark:border-gray-700 px-4 py-2 rounded-xl shadow-lg ring-1 ring-black/5"
                    >
                        <!-- Left: Play/Pause/Stop -->
                        <div class="flex items-center gap-2">
                            <button
                                id="play-pause-btn"
                                class="w-8 h-8 rounded-full bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center transition-all active:scale-95"
                                title="Play/Pause (Space)"
                            >
                                <!-- Play Icon -->
                                <svg
                                    id="icon-play"
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                    stroke="none"
                                    ><polygon points="5 3 19 12 5 21 5 3"
                                    ></polygon></svg
                                >
                                <!-- Pause Icon -->
                                <svg
                                    id="icon-pause"
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                    stroke="none"
                                    class="hidden"
                                    ><rect x="6" y="4" width="4" height="16"
                                    ></rect><rect
                                        x="14"
                                        y="4"
                                        width="4"
                                        height="16"></rect></svg
                                >
                            </button>

                            <button
                                id="stop-btn"
                                class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 flex items-center justify-center transition-all active:scale-95"
                                title="Stop"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                    stroke="none"
                                    ><rect x="4" y="4" width="16" height="16"
                                    ></rect></svg
                                >
                            </button>
                        </div>

                        <!-- Simple PreviousFrame/NextFrame (Hidden features for now or add small buttons) -->
                    </div>

                    <!-- Center: Time -->
                    <div
                        class="font-mono text-xs font-semibold text-gray-700 dark:text-gray-300 select-none"
                    >
                        <span id="time-current">0.00</span>s <span
                            class="text-gray-400">/</span
                        >
                        <span id="time-total">5.00</span>s
                    </div>

                    <!-- Right: Settings -->
                    <div class="flex items-center gap-2">
                        <button
                            id="loop-btn"
                            class="p-1.5 rounded-lg text-blue-600 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors"
                            title="Toggle Loop"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><path d="m7 10 5-6 5 6"></path><path
                                    d="M21 12H7"></path><path d="m17 14-5 6-5-6"
                                ></path><path d="M3 12h14"></path></svg
                            >
                        </button>
                    </div>
                </div>
            </div>
        </main>
        <!-- Removed closing div from here -->
        <!-- Right Sidebar (Properties & Layers) -->
        <aside
            id="right-sidebar"
            class="fixed right-0 top-14 bottom-0 w-80 bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-800 flex flex-col z-40 shadow-xl shrink-0 h-[calc(100vh-3.5rem)] transition-transform duration-300 translate-x-full sm:translate-x-0 sm:relative sm:top-0 sm:h-full right-sidebar"
        >
            <!-- Tabs -->
            <div
                class="flex items-center border-b border-gray-200 dark:border-gray-800 relative z-30"
            >
                <button
                    id="tab-inspector"
                    class="flex-1 py-3 text-[10px] font-bold uppercase tracking-wider text-blue-600 border-b-2 border-blue-600 bg-blue-50/50 dark:bg-blue-900/10 transition-colors"
                >
                    Inspector
                </button>
                <button
                    id="tab-layers"
                    class="flex-1 py-3 text-[10px] font-bold uppercase tracking-wider text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors border-b-2 border-transparent"
                >
                    Layers
                </button>
            </div>

            <div class="flex-1 flex flex-col overflow-hidden relative">
                <!-- Inspector View -->
                <div
                    id="view-inspector"
                    class="absolute inset-0 flex flex-col overflow-hidden bg-white dark:bg-gray-900 z-10"
                >
                    <PropertiesPanel />
                </div>

                <!-- Layers View -->
                <div
                    id="view-layers"
                    class="absolute inset-0 flex flex-col overflow-hidden bg-white dark:bg-gray-900 hidden"
                >
                    <div
                        class="p-2 border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50"
                    >
                        <div class="relative">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="absolute left-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><circle cx="11" cy="11" r="8"></circle><path
                                    d="m21 21-4.3-4.3"></path></svg
                            >
                            <input
                                type="text"
                                placeholder="Filter layers..."
                                class="w-full pl-8 pr-2 py-1.5 text-xs bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 text-gray-700 dark:text-gray-300"
                            />
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        <LayersPanel />
                    </div>
                </div>
            </div>
        </aside>
    </div>
</Layout>

<script>
    import { StudioEngine } from "../utils/studio/StudioEngine";
    import { CanvasText } from "../utils/studio/renderers/CanvasText";
    import { CanvasChart } from "../utils/studio/renderers/CanvasChart";
    import { CanvasImage } from "../utils/studio/renderers/CanvasImage";
    import { CanvasProgress } from "../utils/studio/renderers/CanvasProgress";
    import { CanvasCode } from "../utils/studio/renderers/CanvasCode";
    import { CanvasCounter } from "../utils/studio/renderers/CanvasCounter";

    let engine: StudioEngine;
    const canvas = document.getElementById(
        "studio-canvas",
    ) as HTMLCanvasElement;

    // Initialize Engine
    if (canvas) {
        engine = new StudioEngine(canvas);

        // Expose for child components
        (window as any).studioEngine = engine;
        window.dispatchEvent(new Event("studio:ready"));

        // Initial State
        const demoText = new CanvasText("demo-1", {
            text: "Kinetix Studio",
            x: 600,
            y: 300,
            fontSize: 80,
            color: "#60a5fa",
        });
        engine.addObject(demoText);
    }

    // --- Global Event Listeners (Glue) ---
    window.addEventListener("studio:add-object", ((e: CustomEvent) => {
        if (!engine) return;
        const { type } = e.detail;
        const id = `${type}-${Date.now()}`;

        // Center offset
        const cx = 960; // Approx center of 1920
        const cy = 540; // Approx center of 1080

        if (type === "text") {
            engine.addObject(new CanvasText(id, { x: cx - 200, y: cy }));
        } else if (type === "chart") {
            engine.addObject(
                new CanvasChart(id, {
                    x: cx - 200,
                    y: cy - 150,
                    chartType: "bar",
                }),
            );
        } else if (type === "image") {
            engine.addObject(new CanvasImage(id, { x: cx - 200, y: cy - 150 }));
        } else if (type === "progress") {
            engine.addObject(new CanvasProgress(id, { x: cx - 150, y: cy }));
        } else if (type === "code") {
            engine.addObject(new CanvasCode(id, { x: cx - 200, y: cy - 100 }));
        } else if (type === "counter") {
            engine.addObject(new CanvasCounter(id, { x: cx, y: cy }));
        }
    }) as EventListener);

    // --- Playback Controls ---
    const playPauseBtn = document.getElementById("play-pause-btn");
    const stopBtn = document.getElementById("stop-btn");
    const iconPlay = document.getElementById("icon-play");
    const iconPause = document.getElementById("icon-pause");
    const timeCurrent = document.getElementById("time-current");
    const timeTotal = document.getElementById("time-total");
    const loopBtn = document.getElementById("loop-btn");

    // Timeline UI
    const timelineContainer = document.getElementById("timeline-container");
    const timelineProgress = document.getElementById("timeline-progress");
    const timelineHandle = document.getElementById("timeline-handle");

    function updatePlayStateUI(isPlaying: boolean) {
        if (isPlaying) {
            iconPlay?.classList.add("hidden");
            iconPause?.classList.remove("hidden");
        } else {
            iconPlay?.classList.remove("hidden");
            iconPause?.classList.add("hidden");
        }
    }

    if (playPauseBtn) {
        playPauseBtn.addEventListener("click", () => {
            if (!engine) return;
            // Check engine state directly or infer from UI?
            // Better to check engine's isPlaying atom or just toggle based on current state check
            if (iconPause?.classList.contains("hidden")) {
                engine.play();
                // updatePlayStateUI(true); // Handled by sync loop now
            } else {
                engine.pause();
                // updatePlayStateUI(false); // Handled by sync loop now
            }
        });
    }

    if (stopBtn) {
        stopBtn.addEventListener("click", () => {
            if (!engine) return;
            engine.stop();
        });
    }

    if (loopBtn) {
        loopBtn.addEventListener("click", () => {
            if (!engine) return;
            engine.isLooping = !engine.isLooping;
            loopBtn.classList.toggle("text-blue-600");
            loopBtn.classList.toggle("text-gray-400");
            loopBtn.classList.toggle("bg-blue-50");
        });
    }

    // Timeline Interaction
    let isScrubbing = false;

    if (timelineContainer) {
        const updateScrub = (e: MouseEvent) => {
            if (!engine) return;
            const rect = timelineContainer.getBoundingClientRect();
            const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
            const pct = x / rect.width;
            const targetTime = pct * engine.totalDuration;
            engine.seek(targetTime);
            updateTimelineUI(targetTime);
        };

        timelineContainer.addEventListener("mousedown", (e) => {
            isScrubbing = true;
            if (engine) engine.pause();
            updateScrub(e);
        });

        window.addEventListener("mousemove", (e) => {
            if (isScrubbing) {
                e.preventDefault();
                updateScrub(e);
            }
        });

        window.addEventListener("mouseup", () => {
            if (isScrubbing) {
                isScrubbing = false;
                // Don't auto-resume, let user decide or leave paused.
                // engine.play(); // Optional if we want auto-resume
            }
        });
    }

    function updateTimelineUI(timeMs: number) {
        if (!engine) return;
        const total = engine.totalDuration;
        const pct = Math.max(0, Math.min(1, timeMs / total)) * 100;

        if (timelineProgress) timelineProgress.style.width = `${pct}%`;
        if (timelineHandle) timelineHandle.style.left = `${pct}%`;

        if (timeCurrent) timeCurrent.textContent = (timeMs / 1000).toFixed(2);
        if (timeTotal) timeTotal.textContent = (total / 1000).toFixed(2);
    }

    // Time Loop (UI Sync)
    // --- Event Listeners (UI Sync) ---

    // Time Update
    window.addEventListener("studio:timeupdate", ((e: CustomEvent) => {
        if (!isScrubbing) {
            updateTimelineUI(e.detail.time);
        }
    }) as EventListener);

    // Play State Update
    window.addEventListener("studio:playstate", ((e: CustomEvent) => {
        updatePlayStateUI(e.detail.isPlaying);
    }) as EventListener);

    // --- Theme Toggle ---
    const themeBtn = document.getElementById("theme-toggle");
    // ... code ...

    // --- Sidebar Toggle ---
    const toggleSidebarBtn = document.getElementById("toggle-sidebar");
    const rightSidebar = document.getElementById("right-sidebar");

    toggleSidebarBtn?.addEventListener("click", () => {
        rightSidebar?.classList.toggle("translate-x-full");
    });
    const sunIcon = document.getElementById("icon-sun");
    const moonIcon = document.getElementById("icon-moon");
    const body = document.body;
    const html = document.documentElement;

    if (!body.classList.contains("light-mode")) {
        body.classList.add("light-mode");
    }

    function updateThemeUI() {
        const isLight = body.classList.contains("light-mode");
        if (isLight) {
            html.classList.remove("dark");
            sunIcon?.classList.remove("hidden");
            moonIcon?.classList.add("hidden");
        } else {
            html.classList.add("dark");
            sunIcon?.classList.add("hidden");
            moonIcon?.classList.remove("hidden");
        }
    }
    updateThemeUI();

    themeBtn?.addEventListener("click", () => {
        body.classList.toggle("light-mode");
        updateThemeUI();
    });

    // --- Sidebar Tabs ---
    const tabInspector = document.getElementById("tab-inspector");
    const tabLayers = document.getElementById("tab-layers");
    const viewInspector = document.getElementById("view-inspector");
    const viewLayers = document.getElementById("view-layers");

    if (tabInspector && tabLayers && viewInspector && viewLayers) {
        function switchTab(tab: string) {
            if (tab === "inspector") {
                tabInspector?.classList.add(
                    "text-blue-600",
                    "border-blue-600",
                    "bg-blue-50/50",
                    "dark:bg-blue-900/10",
                );
                tabInspector?.classList.remove(
                    "text-gray-500",
                    "border-transparent",
                    "hover:text-gray-700",
                );
                tabLayers?.classList.add(
                    "text-gray-500",
                    "border-transparent",
                    "hover:text-gray-700",
                );
                tabLayers?.classList.remove(
                    "text-blue-600",
                    "border-blue-600",
                    "bg-blue-50/50",
                    "dark:bg-blue-900/10",
                );
                viewInspector?.classList.remove("hidden");
                viewLayers?.classList.add("hidden");
            } else {
                tabLayers?.classList.add(
                    "text-blue-600",
                    "border-blue-600",
                    "bg-blue-50/50",
                    "dark:bg-blue-900/10",
                );
                tabLayers?.classList.remove(
                    "text-gray-500",
                    "border-transparent",
                    "hover:text-gray-700",
                );
                tabInspector?.classList.add(
                    "text-gray-500",
                    "border-transparent",
                    "hover:text-gray-700",
                );
                tabInspector?.classList.remove(
                    "text-blue-600",
                    "border-blue-600",
                    "bg-blue-50/50",
                    "dark:bg-blue-900/10",
                );
                viewLayers?.classList.remove("hidden");
                viewInspector?.classList.add("hidden");
            }
        }
        tabInspector.addEventListener("click", () => switchTab("inspector"));
        tabLayers.addEventListener("click", () => switchTab("layers"));
    }
</script>
