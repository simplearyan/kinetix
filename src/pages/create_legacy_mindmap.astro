---
import Layout from "../layouts/Layout.astro";
import {
    Palette,
    Share2,
    Download,
    Sparkles,
    Layout as LayoutIcon,
    Type,
    Trash2,
    Network,
    BarChart3,
    PieChart,
    GitMerge,
} from "lucide-react";
---

<Layout title="Create | Kinetix" showFooter={false}>
    <div class="flex h-[calc(100vh-64px)] overflow-hidden">
        <!-- Left Pane: Editor -->
        <div
            id="editor-pane"
            class="flex flex-col border-r border-slate-200 bg-white w-[360px] transition-all duration-300 z-20 shadow-xl"
        >
            <!-- Header -->
            <div
                class="p-4 border-b border-slate-100 flex items-center justify-between bg-white shrink-0"
            >
                <input
                    type="text"
                    id="project-title-input"
                    placeholder="UNTITLED PROJECT"
                    class="text-xs font-semibold text-slate-600 uppercase tracking-wider bg-transparent hover:bg-slate-50 focus:bg-slate-50 border-transparent border focus:border-slate-200 rounded px-1 -ml-1 w-full max-w-[150px] outline-none transition-colors"
                />
                <button
                    id="clear-btn"
                    class="p-1 hover:bg-red-50 hover:text-red-500 rounded text-slate-400 transition-colors"
                    title="Clear Project"
                >
                    <Trash2 size={14} />
                </button>
            </div>

            <!-- Text Area -->
            <div class="flex-1 relative bg-white">
                <textarea
                    id="editor-textarea"
                    class="w-full h-full p-6 resize-none focus:outline-none text-slate-700 leading-relaxed font-mono text-sm"
                    placeholder="Type your outline here..."
                    spellcheck="false"
                    >Mindmap: Root Idea Branch 1 Detail A Detail B Branch 2
                    Detail C</textarea
                >

                <!-- Generate Button (Floating) -->
                <div class="absolute bottom-6 right-6">
                    <button
                        id="generate-btn"
                        class="flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-full shadow-lg shadow-slate-900/20 hover:scale-105 transition-transform font-bold text-xs uppercase tracking-wide"
                    >
                        <Sparkles size={14} />
                        Generate
                    </button>
                </div>
            </div>

            <!-- Footer Controls -->
            <div
                class="bg-slate-50 border-t border-slate-200 p-2 flex flex-col gap-3 shrink-0"
            >
                <!-- Templates -->
                <div>
                    <div
                        class="text-[10px] font-bold text-slate-400 uppercase tracking-wider px-2 mb-2"
                    >
                        Templates
                    </div>
                    <div class="grid grid-cols-4 gap-1">
                        <button
                            data-template="mindmap"
                            class="template-btn flex flex-col items-center justify-center p-2 rounded-lg bg-white border border-slate-200 hover:border-blue-400 hover:text-blue-600 transition-colors text-[10px] font-medium text-slate-600 gap-1"
                        >
                            <Network size={16} />
                            <span>Mind</span>
                        </button>
                        <button
                            data-template="bar"
                            class="template-btn flex flex-col items-center justify-center p-2 rounded-lg bg-white border border-slate-200 hover:border-blue-400 hover:text-blue-600 transition-colors text-[10px] font-medium text-slate-600 gap-1"
                        >
                            <BarChart3 size={16} />
                            <span>Bar</span>
                        </button>
                        <button
                            data-template="line"
                            class="template-btn flex flex-col items-center justify-center p-2 rounded-lg bg-white border border-slate-200 hover:border-blue-400 hover:text-blue-600 transition-colors text-[10px] font-medium text-slate-600 gap-1"
                        >
                            <!-- Icon: Line Chart -->
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><path d="M3 3v18h18"></path><path
                                    d="m19 9-5 5-4-4-3 3"></path></svg
                            >
                            <span>Line</span>
                        </button>
                        <button
                            data-template="funnel"
                            class="template-btn flex flex-col items-center justify-center p-2 rounded-lg bg-white border border-slate-200 hover:border-blue-400 hover:text-blue-600 transition-colors text-[10px] font-medium text-slate-600 gap-1"
                        >
                            <!-- Icon: Funnel (Filter) -->
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><polygon
                                    points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"
                                ></polygon></svg
                            >
                            <span>Funnel</span>
                        </button>

                        <button
                            data-template="pie"
                            class="template-btn flex flex-col items-center justify-center p-2 rounded-lg bg-white border border-slate-200 hover:border-blue-400 hover:text-blue-600 transition-colors text-[10px] font-medium text-slate-600 gap-1"
                        >
                            <PieChart size={16} />
                            <span>Pie</span>
                        </button>
                        <button
                            data-template="process"
                            class="template-btn flex flex-col items-center justify-center p-2 rounded-lg bg-white border border-slate-200 hover:border-blue-400 hover:text-blue-600 transition-colors text-[10px] font-medium text-slate-600 gap-1"
                        >
                            <GitMerge size={16} />
                            <span>Flow</span>
                        </button>
                        <button
                            data-template="venn"
                            class="template-btn flex flex-col items-center justify-center p-2 rounded-lg bg-white border border-slate-200 hover:border-blue-400 hover:text-blue-600 transition-colors text-[10px] font-medium text-slate-600 gap-1"
                        >
                            <!-- Icon: Venn (Circles) -->
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><circle cx="8" cy="12" r="6"></circle><circle
                                    cx="16"
                                    cy="12"
                                    r="6"></circle></svg
                            >
                            <span>Venn</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Pane: Canvas -->
        <div
            id="canvas-container"
            class="flex-1 relative flex flex-col bg-slate-50 transition-colors duration-500 overflow-hidden"
        >
            <!-- Toolbar -->
            <!-- Toolbar -->
            <div class="absolute top-4 left-1/2 -translate-x-1/2 flex z-20">
                <div
                    class="bg-white/90 backdrop-blur rounded-full shadow-sm border border-slate-200 p-1 flex items-center gap-1 text-slate-600"
                >
                    <!-- Fonts -->
                    <div
                        class="flex items-center bg-slate-100 rounded-full p-1"
                        id="font-group"
                    >
                        <button
                            data-font="sans"
                            class="font-btn px-3 py-1 rounded-full text-xs font-medium transition-all bg-slate-900 text-white font-sans"
                            title="Sans Serif">Aa</button
                        >
                        <button
                            data-font="hand"
                            class="font-btn px-3 py-1 rounded-full text-xs font-medium transition-all hover:text-slate-900 font-hand"
                            title="Hand-drawn">Aa</button
                        >
                        <button
                            data-font="serif"
                            class="font-btn px-3 py-1 rounded-full text-xs font-medium transition-all hover:text-slate-900 font-serif"
                            title="Serif">Aa</button
                        >
                    </div>

                    <div class="w-px h-4 bg-slate-200 mx-1"></div>

                    <!-- Variants -->
                    <div
                        class="flex items-center bg-slate-100 rounded-full p-1"
                        id="variant-group"
                    >
                        <button
                            data-variant="corporate"
                            class="variant-btn px-3 py-1 rounded-full text-xs font-medium transition-all bg-white shadow-sm text-slate-900"
                            >Clean</button
                        >
                        <button
                            data-variant="hand-drawn"
                            class="variant-btn px-3 py-1 rounded-full text-xs font-medium transition-all hover:text-slate-900"
                            >Sketch</button
                        >
                        <button
                            data-variant="neon"
                            class="variant-btn px-3 py-1 rounded-full text-xs font-medium transition-all hover:text-slate-900"
                            >Neon</button
                        >
                    </div>

                    <div class="w-px h-4 bg-slate-200 mx-1"></div>

                    <!-- Customization Toggle -->
                    <button
                        id="customize-toggle"
                        class="p-2 hover:bg-slate-50 rounded-full transition-colors text-slate-600 relative"
                    >
                        <Palette size={18} />
                        <!-- Popover -->
                        <div
                            id="customize-popover"
                            class="hidden absolute top-full left-1/2 -translate-x-1/2 mt-4 bg-white rounded-xl shadow-xl border border-slate-100 p-4 w-[280px] text-left"
                        >
                            <div
                                class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3"
                            >
                                Customization
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-slate-600"
                                        >Background</span
                                    >
                                    <input
                                        type="color"
                                        id="bg-color-picker"
                                        class="w-6 h-6 rounded cursor-pointer border-0 p-0"
                                        value="#ffffff"
                                    />
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-slate-600"
                                        >Accent</span
                                    >
                                    <input
                                        type="color"
                                        id="accent-color-picker"
                                        class="w-6 h-6 rounded cursor-pointer border-0 p-0"
                                        value="#3b82f6"
                                    />
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-slate-600"
                                        >Text</span
                                    >
                                    <input
                                        type="color"
                                        id="text-color-picker"
                                        class="w-6 h-6 rounded cursor-pointer border-0 p-0"
                                        value="#1e293b"
                                    />
                                </div>
                            </div>
                        </div>
                    </button>

                    <div class="w-px h-4 bg-slate-200 mx-1"></div>

                    <!-- Export Toggle -->
                    <button
                        id="export-toggle"
                        class="p-2 hover:bg-slate-50 rounded-full transition-colors text-slate-600 relative"
                    >
                        <Download size={18} />
                        <!-- Export Popover -->
                        <div
                            id="export-popover"
                            class="hidden absolute top-full right-0 mt-4 bg-white rounded-xl shadow-xl border border-slate-100 p-2 min-w-[200px] text-left z-30"
                        >
                            <div class="flex flex-col gap-1">
                                <button
                                    id="export-png-btn"
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 w-full text-left"
                                >
                                    <span
                                        class="font-bold text-xs bg-blue-100 text-blue-600 px-1 rounded"
                                        >PNG</span
                                    >
                                    <span>Image</span>
                                </button>
                                <button
                                    id="export-png-trans-btn"
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 w-full text-left"
                                >
                                    <span
                                        class="font-bold text-xs bg-slate-100 text-slate-600 px-1 rounded"
                                        >PNG</span
                                    >
                                    <span>Transparent</span>
                                </button>
                                <button
                                    id="export-svg-btn"
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 w-full text-left"
                                >
                                    <span
                                        class="font-bold text-xs bg-purple-100 text-purple-600 px-1 rounded"
                                        >SVG</span
                                    >
                                    <span>Vector</span>
                                </button>
                                <div class="h-px bg-slate-100 my-1"></div>
                                <button
                                    id="copy-btn"
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 w-full text-left"
                                >
                                    <Share2 size={14} />
                                    <span>Copy Image</span>
                                </button>
                                <button
                                    id="export-json-btn"
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 w-full text-left"
                                >
                                    <Type size={14} />
                                    <span>Save Project (JSON)</span>
                                </button>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- The Visualizer Canvas -->
        <div
            class="flex-1 flex items-center justify-center p-8 overflow-auto scale-area"
        >
            <div
                id="visualizer-stage"
                class="rounded-xl shadow-sm border border-slate-200 w-full max-w-5xl aspect-video p-12 flex items-center justify-center relative overflow-hidden bg-white transition-colors duration-300"
            >
                <div
                    id="diagram-root"
                    class="w-full h-full flex items-center justify-center"
                >
                    <!-- Diagram content will be injected here -->
                </div>
                <div
                    class="absolute bottom-4 right-4 text-xs text-slate-300 font-medium select-none"
                >
                    Kinetix
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { Parser } from "../engine/Parser";
    import { toPng, toSvg } from "html-to-image";
    import download from "downloadjs";

    // State
    const state = {
        text: "Mindmap:\nRoot Idea\n  Branch 1\n    Detail A\n    Detail B\n  Branch 2\n    Detail C",
        variant: "corporate", // corporate, hand-drawn, neon
        font: "sans", // sans, hand, serif
        config: {
            title: "Untitled Project",
            backgroundColor: "#ffffff",
            accentColor: "#3b82f6",
            textColor: "#1e293b",
        },
        data: null,
    };

    // Elements
    const textarea = document.getElementById("editor-textarea");
    const titleInput = document.getElementById("project-title-input");
    const root = document.getElementById("diagram-root");
    const stage = document.getElementById("visualizer-stage");
    const container = document.getElementById("canvas-container");
    const customizePopover = document.getElementById("customize-popover");
    const exportPopover = document.getElementById("export-popover");

    // Config Inputs
    const bgColorPicker = document.getElementById("bg-color-picker");
    const accentColorPicker = document.getElementById("accent-color-picker");
    const textColorPicker = document.getElementById("text-color-picker");

    // Init
    function init() {
        // Load from localstorage if available
        const saved = localStorage.getItem("kinetix-vanilla-project");
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                state.text = parsed.text;
                state.variant = parsed.variant;
                state.font = parsed.font || "sans";
                state.config = { ...state.config, ...parsed.config };

                // Update UI from state
                if (textarea) textarea.value = state.text;
                if (titleInput) titleInput.value = state.config.title;
                if (bgColorPicker)
                    bgColorPicker.value = state.config.backgroundColor;
                if (accentColorPicker)
                    accentColorPicker.value = state.config.accentColor;
                if (textColorPicker)
                    textColorPicker.value = state.config.textColor;

                updateVariantUI();
                updateFontUI();
            } catch (e) {}
        }

        render();

        // Listeners
        textarea?.addEventListener("input", (e) => {
            state.text = e.target.value;
            save();
            render();
        });

        titleInput?.addEventListener("input", (e) => {
            state.config.title = e.target.value;
            save();
        });

        // Variant Buttons
        document.querySelectorAll(".variant-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                state.variant = e.target.getAttribute("data-variant");
                updateVariantUI();
                save();
                render();
            });
        });

        // Font Buttons
        document.querySelectorAll(".font-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                state.font = e.target.getAttribute("data-font");
                updateFontUI();
                save();
            });
        });

        // Template Buttons
        document.querySelectorAll(".template-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const tmpl = e.currentTarget.getAttribute("data-template");
                applyTemplate(tmpl);
            });
        });

        // Popover Toggles
        document
            .getElementById("customize-toggle")
            ?.addEventListener("click", (e) => {
                e.stopPropagation();
                customizePopover?.classList.toggle("hidden");
                exportPopover?.classList.add("hidden");
            });

        document
            .getElementById("export-toggle")
            ?.addEventListener("click", (e) => {
                e.stopPropagation();
                exportPopover?.classList.toggle("hidden");
                customizePopover?.classList.add("hidden");
            });

        // Close popovers on click outside
        document.addEventListener("click", () => {
            customizePopover?.classList.add("hidden");
            exportPopover?.classList.add("hidden");
        });

        // Prevent closing when clicking inside
        customizePopover?.addEventListener("click", (e) => e.stopPropagation());
        exportPopover?.addEventListener("click", (e) => e.stopPropagation());

        bgColorPicker?.addEventListener("input", (e) => {
            state.config.backgroundColor = e.target.value;
            applyStyles();
            save();
        });

        accentColorPicker?.addEventListener("input", (e) => {
            state.config.accentColor = e.target.value;
            applyStyles();
            save();
        });

        textColorPicker?.addEventListener("input", (e) => {
            state.config.textColor = e.target.value;
            applyStyles();
            save();
        });

        // --- EXPORT HANDLERS ---

        // PNG
        document
            .getElementById("export-png-btn")
            ?.addEventListener("click", async () => {
                if (stage) {
                    const dataUrl = await toPng(stage, { skipFonts: true });
                    download(dataUrl, "kinetix-export.png");
                }
            });

        // Transparent PNG
        document
            .getElementById("export-png-trans-btn")
            ?.addEventListener("click", async () => {
                if (stage) {
                    const originalBg = stage.style.backgroundColor;
                    stage.style.backgroundColor = "transparent"; // Force transparent
                    try {
                        const dataUrl = await toPng(stage, {
                            skipFonts: true,
                            backgroundColor: null,
                        });
                        download(dataUrl, "kinetix-export-transparent.png");
                    } finally {
                        stage.style.backgroundColor = originalBg; // Restore
                    }
                }
            });

        // SVG
        document
            .getElementById("export-svg-btn")
            ?.addEventListener("click", async () => {
                if (stage) {
                    const dataUrl = await toSvg(stage, { skipFonts: true });
                    download(dataUrl, "kinetix-export.svg");
                }
            });

        // Copy Image
        document
            .getElementById("copy-btn")
            ?.addEventListener("click", async () => {
                if (stage) {
                    try {
                        const blob = await toBlobPointer(stage);
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                [blob.type]: blob,
                            }),
                        ]);
                        alert("Copied to clipboard!");
                    } catch (e) {
                        console.error(e);
                        alert("Failed to copy");
                    }
                }
            });

        // JSON
        document
            .getElementById("export-json-btn")
            ?.addEventListener("click", () => {
                const dataStr =
                    "data:text/json;charset=utf-8," +
                    encodeURIComponent(JSON.stringify(state, null, 2));
                download(dataStr, "kinetix-project.json", "application/json");
            });

        document.getElementById("clear-btn")?.addEventListener("click", () => {
            if (confirm("Clear project?")) {
                textarea.value = "";
                state.text = "Mindmap:\nNew Idea";
                render();
            }
        });
    }

    // Helper for Blob
    async function toBlobPointer(node) {
        // html-to-image doesn't export toBlob directly in all versions,
        // but we can use toPng -> fetch -> blob
        const dataUrl = await toPng(node, { skipFonts: true });
        const res = await fetch(dataUrl);
        return await res.blob();
    }

    function save() {
        localStorage.setItem("kinetix-vanilla-project", JSON.stringify(state));
    }

    function updateVariantUI() {
        document.querySelectorAll(".variant-btn").forEach((btn) => {
            const v = btn.getAttribute("data-variant");
            if (v === state.variant) {
                btn.classList.add("bg-white", "shadow-sm", "text-slate-900");
            } else {
                btn.classList.remove("bg-white", "shadow-sm", "text-slate-900");
            }
        });
        applyStyles();
    }

    function updateFontUI() {
        document.querySelectorAll(".font-btn").forEach((btn) => {
            const f = btn.getAttribute("data-font");
            if (f === state.font) {
                btn.classList.add("bg-slate-900", "text-white");
                btn.classList.remove("bg-white", "text-slate-900");
            } else {
                btn.classList.remove("bg-slate-900", "text-white");
                btn.classList.add("bg-white", "text-slate-900");
            }
        });
        applyStyles();
    }

    function applyTemplate(type) {
        let t = "";
        if (type === "mindmap") t = "Mindmap:\nMain Idea\n  Topic 1\n  Topic 2";
        if (type === "bar") t = "Bar: Sales\nJan, 100\nFeb, 150\nMar, 120";
        if (type === "line")
            t = "Line: Growth\n2020, 10\n2021, 25\n2022, 50\n2023, 110";
        if (type === "pie") t = "Pie: Allocation\nStocks, 60\nBonds, 40";
        if (type === "process") t = "Process:\n1. Step One\n2. Step Two";
        if (type === "funnel")
            t =
                "Funnel: Conversions\nImpressions, 1000\nClicks, 500\nSignups, 100\nSales, 20";
        if (type === "venn") t = "Venn:\nProduct\nEngineering\nDesign"; // Simple intersection

        state.text = t;
        textarea.value = t;
        render();
    }

    // --- Core Rendering ---

    function applyStyles() {
        if (!stage) return;

        // Background
        if (state.config.backgroundColor) {
            stage.style.backgroundColor = state.config.backgroundColor;
            stage.style.backgroundImage = "none";
        } else {
            if (state.variant === "neon") {
                stage.style.backgroundColor = "#0f172a";
            } else {
                stage.style.backgroundColor = "#ffffff";
            }
        }

        // Fonts
        stage.classList.remove("font-sans", "font-hand", "font-serif");
        stage.classList.add(`font-${state.font}`);

        // Propagate colors
        root?.style.setProperty("--accent-color", state.config.accentColor);
        root?.style.setProperty("--text-color", state.config.textColor);

        // Re-Apply specific styles to nodes without re-rendering logic
        const nodes = root.querySelectorAll(".diagram-node");
        nodes.forEach((node) => updateNodeStyle(node));

        // Chart bars
        const bars = root.querySelectorAll(".chart-bar");
        bars.forEach((bar) => {
            bar.style.backgroundColor = state.config.accentColor;
        });

        // Lines / Paths (SVG)
        const paths = root.querySelectorAll("path");
        paths.forEach((path) => {
            // Only update stroke for Line charts if it's the main line
            if (path.dataset.type === "line-path") {
                path.setAttribute("stroke", state.config.accentColor);
            }
        });
    }

    function updateNodeStyle(node) {
        node.style.color = state.config.textColor;
        // Accent color borders/bgs depending on variant
        if (state.variant === "neon") {
            node.style.borderColor = state.config.accentColor;
            node.style.boxShadow = `0 0 10px ${state.config.accentColor}50`;
        } else if (state.variant === "hand-drawn") {
            // ...
            node.style.borderColor = "black";
            node.style.boxShadow = "2px 2px 0px black";
        } else {
            // Clean
            node.style.borderColor = "#e2e8f0";
            node.style.boxShadow = "0 1px 2px 0 rgb(0 0 0 / 0.05)";
        }
    }

    function render() {
        // Parse
        const data = Parser.parse(state.text);
        state.data = data;

        const type = data.type;

        if (type === "mindmap") renderMindmap(data);
        else if (type === "bar") renderBarChart(data);
        else if (type === "line") renderLineChart(data);
        else if (type === "pie") renderPieChart(data);
        else if (type === "funnel") renderFunnelChart(data);
        else if (type === "venn") renderVennDiagram(data);
        else if (type === "process") renderProcess(data);
        else renderList(data);
    }

    // --- Renderers (Imperative DOM Diffing) ---

    function renderLineChart(data) {
        let container = document.getElementById("line-container");
        if (!container) {
            root.innerHTML = "";
            container = document.createElement("div");
            container.id = "line-container";
            container.className =
                "flex items-center justify-center w-full max-w-3xl h-[300px] relative px-12 pb-8";
            root.appendChild(container);
        }

        // SVG
        let svg = document.getElementById("line-svg");
        if (!svg) {
            svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.id = "line-svg";
            svg.setAttribute("viewBox", "0 0 600 300");
            svg.setAttribute("preserveAspectRatio", "none");
            svg.className = "w-full h-full overflow-visible";
            container.appendChild(svg);
        }

        const values = data.nodes.map((n) => n.value || 0);
        const max = Math.max(...values, 10);

        // Points
        const points = values.map((val, i) => {
            const x = (i / (values.length - 1 || 1)) * 600;
            const y = 300 - (val / max) * 250; // Invert Y
            return { x, y, label: data.nodes[i].label, val };
        });

        // Clear SVG
        svg.innerHTML = "";

        // Draw Path
        if (points.length > 1) {
            const d =
                `M ${points[0].x} ${points[0].y} ` +
                points
                    .slice(1)
                    .map((p) => `L ${p.x} ${p.y}`)
                    .join(" ");

            const path = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "path",
            );
            path.setAttribute("d", d);
            path.setAttribute("fill", "none");
            path.setAttribute("stroke", state.config.accentColor);
            path.setAttribute("stroke-width", "4");
            path.setAttribute("stroke-linecap", "round");
            path.setAttribute("stroke-linejoin", "round");
            path.dataset.type = "line-path";

            // Soft shadow/Area for corporate?
            if (state.variant === "corporate") {
                const areaD =
                    d +
                    ` L ${points[points.length - 1].x} 300 L ${points[0].x} 300 Z`;
                const area = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "path",
                );
                area.setAttribute("d", areaD);
                area.setAttribute("fill", state.config.accentColor);
                area.setAttribute("opacity", "0.2");
                area.setAttribute("stroke", "none");
                svg.appendChild(area);
            }

            svg.appendChild(path);
        }

        // Draw Dots & Labels
        points.forEach((p) => {
            const circle = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "circle",
            );
            circle.setAttribute("cx", p.x);
            circle.setAttribute("cy", p.y);
            circle.setAttribute("r", "6");
            circle.setAttribute("fill", "white");
            circle.setAttribute("stroke", state.config.accentColor);
            circle.setAttribute("stroke-width", "3");
            svg.appendChild(circle);

            // Label
            const text = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "text",
            );
            text.setAttribute("x", p.x);
            text.setAttribute("y", 320); // Below chart
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("fill", state.config.textColor);
            text.setAttribute("font-size", "12");
            text.textContent = p.label;
            svg.appendChild(text);
        });
    }

    function renderFunnelChart(data) {
        let container = document.getElementById("funnel-container");
        if (!container) {
            root.innerHTML = "";
            container = document.createElement("div");
            container.id = "funnel-container";
            container.className =
                "flex flex-col items-center justify-center gap-1 w-full max-w-xl";
            root.appendChild(container);
        }

        container.innerHTML = ""; // Rebuild for simplicity

        const values = data.nodes.map((n) => n.value || 0);
        const max = Math.max(...values, 10);

        data.nodes.forEach((node, i) => {
            const widthPercent = Math.max(((node.value || 0) / max) * 100, 20);

            const row = document.createElement("div");
            row.className =
                "w-full flex items-center justify-center group relative";

            const bar = document.createElement("div");
            bar.className =
                "h-12 flex items-center justify-center text-white font-bold shadow-sm transition-all relative overflow-hidden";
            bar.style.width = `${widthPercent}%`;
            bar.style.backgroundColor = state.config.accentColor;
            bar.style.opacity = 1 - i * 0.15; // Fade down

            // Skew for funnel shape?
            // Simple CSS trapezoid is hard with text inside.
            // Visual trick: rounded corners varying?
            // Let's stick to bars for now, but centered.
            bar.style.borderRadius = "8px";

            const label = document.createElement("span");
            label.className = "z-10 text-xs drop-shadow-md";
            label.textContent = `${node.label} (${node.value})`;
            bar.appendChild(label);

            row.appendChild(bar);
            container.appendChild(row);
        });
    }

    function renderVennDiagram(data) {
        let container = document.getElementById("venn-container");
        if (!container) {
            root.innerHTML = "";
            container = document.createElement("div");
            container.id = "venn-container";
            container.className =
                "relative flex items-center justify-center w-[400px] h-[300px]";
            root.appendChild(container);
        }

        container.innerHTML = "";

        // 2 Sets Logic usually
        const sets = data.nodes.slice(0, 3); // Limit to 3 for mockup

        // CSS-based Venn
        sets.forEach((node, i) => {
            const circle = document.createElement("div");
            circle.className =
                "absolute rounded-full flex items-center justify-center text-center p-4 transition-transform hover:scale-105 border-2 border-white/50 backdrop-blur-sm shadow-sm";
            circle.style.backgroundColor = state.config.accentColor;
            circle.style.opacity = "0.6";
            circle.style.width = "200px";
            circle.style.height = "200px";
            circle.style.color = state.variant === "neon" ? "white" : "black"; // text inside might be bad if dark
            if (state.variant !== "neon") circle.style.color = "white";

            if (i === 0) {
                circle.style.left = "0";
                circle.style.zIndex = "10";
            } else if (i === 1) {
                circle.style.right = "0";
                circle.style.zIndex = "10";
            } else if (i === 2) {
                circle.style.top = "50%";
                circle.style.left = "50%";
                circle.style.transform = "translate(-50%, -20%)";
                circle.style.width = "150px";
                circle.style.height = "150px";
                circle.style.zIndex = "20";
                // This is technically the intersection in a 3-way, or just a 3rd set.
            }

            const label = document.createElement("span");
            label.className =
                "font-bold text-lg pointer-events-none drop-shadow-md";
            label.innerText = node.label;
            circle.appendChild(label);

            container.appendChild(circle);
        });
    }

    function renderBarChart(data) {
        // Check if root already has bar chart container
        let container = document.getElementById("barchart-container");
        if (!container) {
            root.innerHTML = ""; // Switch layout
            container = document.createElement("div");
            container.id = "barchart-container";
            container.className =
                "flex items-end justify-center gap-6 h-[70%] w-full max-w-3xl px-8 pb-12";
            root.appendChild(container);
        }

        const values = data.nodes.map((n) => n.value || 0);
        const max = Math.max(...values, 10) || 100;

        // Diff Nodes
        const existing = new Set();

        data.nodes.forEach((node, i) => {
            const id = node.id || `bar-${i}`;
            existing.add(id);

            let el = document.getElementById(id);
            if (!el) {
                // Create
                el = document.createElement("div");
                el.id = id;
                el.className =
                    "chart-node flex flex-col items-center gap-2 group w-16 h-full justify-end relative transition-all duration-500 ease-out";

                const label = document.createElement("div");
                label.className =
                    "text-center text-xs font-semibold mt-2 truncate w-full transition-colors";
                label.dataset.part = "label";

                const valueLabel = document.createElement("div");
                valueLabel.className =
                    "absolute -top-6 text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity";
                valueLabel.dataset.part = "value";

                const bar = document.createElement("div");
                bar.className =
                    "chart-bar w-full rounded-t-md transition-all duration-500 relative";
                // Deterministic sketch rotation
                if (state.variant === "hand-drawn") {
                    const rot = (i % 2 === 0 ? 0.5 : -0.5) + Math.sin(i) * 0.5;
                    bar.style.transform = `rotate(${rot}deg)`;
                }
                bar.dataset.part = "bar";

                el.appendChild(valueLabel);
                el.appendChild(bar);
                el.appendChild(label);
                container.appendChild(el);
            }

            // Update
            const bar = el.querySelector('[data-part="bar"]');
            const label = el.querySelector('[data-part="label"]');
            const valLabel = el.querySelector('[data-part="value"]');

            const height = Math.max(((node.value || 0) / max) * 100, 2);
            bar.style.height = `${height}%`;
            bar.style.backgroundColor = state.config.accentColor;

            label.textContent = node.label;
            label.style.color = state.config.textColor;
            valLabel.textContent = node.value;
            valLabel.style.color = state.config.textColor;

            // Variant Styles
            el.className = clsx_vanilla(
                "chart-node flex flex-col items-center gap-2 group w-16 h-full justify-end relative transition-all duration-500",
                state.variant === "hand-drawn" ? "font-hand" : "font-sans",
            );

            bar.className = clsx_vanilla(
                "chart-bar w-full rounded-t-md transition-all duration-500 relative",
                state.variant === "hand-drawn"
                    ? "border-2 border-slate-900 shadow-[2px_2px_0px_black]"
                    : state.variant === "neon"
                      ? "border-t border-x border-blue-400 shadow-[0_0_15px_blue]"
                      : "shadow-sm",
            );
        });

        // Cleanup
        Array.from(container.children).forEach((child) => {
            if (!existing.has(child.id)) {
                child.remove();
            }
        });
    }

    function renderPieChart(data) {
        let container = document.getElementById("pie-container");
        if (!container) {
            root.innerHTML = "";
            container = document.createElement("div");
            container.id = "pie-container";
            container.className = "relative w-64 h-64";
            root.appendChild(container);
        }

        const values = data.nodes.map((n) => n.value || 0);
        const total = values.reduce((a, b) => a + b, 0);

        // SVG Container
        let svg = document.getElementById("pie-svg");
        if (!svg) {
            svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("viewBox", "0 0 300 300");
            svg.id = "pie-svg";
            svg.className = "w-full h-full overflow-visible";
            container.appendChild(svg);
        }

        let currentAngle = 0;
        const existing = new Set();
        const defaultColors = [
            "#60a5fa",
            "#34d399",
            "#f87171",
            "#fbbf24",
            "#818cf8",
        ];

        data.nodes.forEach((node, i) => {
            const val = node.value || 0;
            if (val <= 0) return;
            const angle = (val / total) * 360;
            const id = `slice-${i}`;
            existing.add(id);

            // Path calc
            const radius = 100;
            const x1 = 150 + radius * Math.cos((Math.PI * currentAngle) / 180);
            const y1 = 150 + radius * Math.sin((Math.PI * currentAngle) / 180);
            const x2 =
                150 +
                radius * Math.cos((Math.PI * (currentAngle + angle)) / 180);
            const y2 =
                150 +
                radius * Math.sin((Math.PI * (currentAngle + angle)) / 180);
            const largeArc = angle > 180 ? 1 : 0;
            const d = `M150,150 L${x1},${y1} A${radius},${radius} 0 ${largeArc},1 ${x2},${y2} Z`;

            let path = document.getElementById(id);
            if (!path) {
                path = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "path",
                );
                path.id = id;
                path.setAttribute(
                    "class",
                    "origin-center hover:scale-105 transition-transform duration-300",
                );
                svg.appendChild(path);
            }

            path.setAttribute("d", d);
            path.setAttribute("fill", defaultColors[i % defaultColors.length]);
            path.setAttribute(
                "stroke",
                state.variant === "neon" ? defaultColors[i] : "white",
            );

            currentAngle += angle;
        });

        // Cleanup paths
        Array.from(svg.children).forEach((child) => {
            if (child.tagName === "path" && !existing.has(child.id)) {
                child.remove();
            }
        });
    }

    function renderMindmap(data) {
        // Mindmap needs recursive rendering.
        // For simple diffing:
        // We'll trust that mindmap structural changes are rare during color tweaks.
        // If color tweaks happen, we update style.
        // If text tweaks happen, we might rebuild.

        // Since layout is complex (flexbox recursion), we might just FULL REBUILD for mindmap on text change,
        // BUT keep it stable on config change.
        // State logic: If 'data' changed, rebuild. If only 'config' changed, Apply Styles.
        // This is handled by `applyStyles()` not calling `render()`, and `render()` only continuing if structure needed.

        // Currently, Render() is called on text input.
        // ApplyStyles() is called on color input.
        // THIS IS THE KEY FIX: separating render (structure) from style (paint).

        let container = document.getElementById("mindmap-root");
        if (!container) {
            root.innerHTML = "";
            container = document.createElement("div");
            container.id = "mindmap-root";
            container.className = "flex items-center justify-center p-8";
            root.appendChild(container);
        }

        // Rebuild if needed. (Check if we need to optimize later).
        // Actually, for Vanilla JS, strict diffing is hard.
        // But since 'Render' is only called on TEXT change, rebuilding is ACCEPTABLE.
        // The user's complaint was "Button click causes reload".
        // Button click (Color) -> trigger applyStyles() -> NO REBUILD.
        // Button click (Variant) -> trigger render()? Maybe rebuild needed for structure.

        container.innerHTML = ""; // Rebuild Logic for now

        const rootNode = data.nodes.find((n) => n.level === 0) || data.nodes[0];
        if (rootNode) {
            container.appendChild(createMindmapNode(rootNode, data.nodes));
        }

        applyStyles(); // Apply colors after build
    }

    function createMindmapNode(node, allNodes) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-center gap-8";

        // Card
        const card = document.createElement("div");
        card.className = clsx_vanilla(
            "diagram-node p-4 rounded-xl shadow-sm bg-white border border-slate-200 z-10 transition-colors",
            state.variant === "hand-drawn"
                ? "font-hand border-2 border-slate-900 shadow-[4px_4px_0px_black]"
                : state.variant === "neon"
                  ? "bg-slate-900 text-blue-100 border-blue-500 shadow-[0_0_10px_blue]"
                  : "",
        );
        card.textContent = node.label;
        wrapper.appendChild(card);

        // Children
        const children = allNodes.filter((n) => n.parentId === node.id);
        if (children.length > 0) {
            const childCol = document.createElement("div");
            childCol.className = "flex flex-col gap-4 relative";
            // Vertical Line
            const vLine = document.createElement("div");
            vLine.className =
                "absolute left-[-2rem] top-0 bottom-0 w-4 border-l-2 border-slate-300 rounded-l-xl";
            vLine.style.transform = "scaleY(0.9)";
            childCol.appendChild(vLine);

            children.forEach((child) => {
                const childWrapper = document.createElement("div");
                childWrapper.className = "relative flex items-center";
                // Horiz Line
                const hLine = document.createElement("div");
                hLine.className = "w-8 h-0.5 bg-slate-300 -ml-8";
                childWrapper.appendChild(hLine);
                childWrapper.appendChild(createMindmapNode(child, allNodes));
                childCol.appendChild(childWrapper);
            });
            wrapper.appendChild(childCol);
        }

        return wrapper;
    }

    function renderProcess(data) {
        let container = document.getElementById("process-container");
        if (!container) {
            root.innerHTML = "";
            container = document.createElement("div");
            container.id = "process-container";
            container.className =
                "flex flex-wrap items-center justify-center gap-4 max-w-4xl";
            root.appendChild(container);
        }

        // Clear for simplicity (since text change = rebuild)
        container.innerHTML = "";

        data.nodes.forEach((node, i) => {
            const div = document.createElement("div");
            div.className = clsx_vanilla(
                "diagram-node relative p-6 w-48 min-h-[100px] flex items-center justify-center text-center rounded-xl bg-white border border-slate-200 shadow-sm",
                state.variant === "hand-drawn"
                    ? "font-hand border-2 border-slate-900 shadow-[4px_4px_0px_black]"
                    : "",
            );
            div.textContent = node.label;

            // Step number
            const badge = document.createElement("div");
            badge.className =
                "absolute -top-3 -left-3 w-8 h-8 rounded-full bg-blue-100 text-blue-600 font-bold flex items-center justify-center border-2 border-white shadow-sm";
            badge.textContent = i + 1;
            div.appendChild(badge);

            container.appendChild(div);
        });

        applyStyles();
    }

    function renderList(data) {
        // Fallback
        root.innerHTML = `<div class="p-8 text-center text-slate-500">${data.nodes.map((n) => n.label).join(", ")}</div>`;
    }

    // Utils
    function clsx_vanilla(base, ...args) {
        return `${base} ${args.filter(Boolean).join(" ")}`;
    }

    // Run
    init();
</script>

<style>
    @import url("https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&family=Outfit:wght@400;500;700&display=swap");

    .font-hand {
        font-family: "Kalam", cursive;
    }
    .font-sans {
        font-family: "Outfit", sans-serif;
    }

    /* Scrollbar */
    #visualizer-stage::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    #visualizer-stage::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }
</style>
