---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Kinetix Engine Demo" showFooter={false} showAds={false}>
    <main class="min-h-screen bg-[#1a1a1a] text-white p-8 font-sans">
        <div class="max-w-[1800px] mx-auto">
            <header class="mb-8 flex justify-between items-center">
                <div>
                    <h1
                        class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400"
                    >
                        Kinetix Core
                    </h1>
                    <p class="text-gray-400 mt-2">
                        Open Source Engine Verification & Demo
                    </p>
                </div>
                <div class="flex gap-4">
                    <a
                        href="/create"
                        class="px-4 py-2 rounded bg-gray-800 hover:bg-gray-700 transition text-sm"
                    >
                        Back to Editor
                    </a>
                    <a
                        href="https://github.com/simplearyan/kinetix"
                        target="_blank"
                        class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-500 transition text-sm font-semibold"
                    >
                        GitHub
                    </a>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- Controls Sidebar -->
                <div class="space-y-6">
                    <!-- Canvas Settings -->
                    <!-- Canvas Settings -->
                    <div
                        id="settings-container"
                        class="bg-[#2a2a2a] p-6 rounded-xl border border-white/5"
                    >
                        <!-- Resolution Picker Mount -->
                    </div>

                    <!-- Project Management -->
                    <div
                        class="bg-[#2a2a2a] p-6 rounded-xl border border-white/5 space-y-4"
                    >
                        <h2
                            class="text-sm font-semibold text-gray-400 uppercase tracking-wider"
                        >
                            Project
                        </h2>
                        <div class="grid grid-cols-2 gap-3">
                            <button
                                id="btn-save"
                                class="bg-gray-700 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm transition"
                            >
                                Save JSON
                            </button>
                            <button
                                id="btn-load"
                                class="bg-gray-700 hover:bg-green-600 text-white px-3 py-2 rounded text-sm transition"
                            >
                                Load JSON
                            </button>
                            <input
                                type="file"
                                id="file-upload"
                                class="hidden"
                                accept=".json"
                            />
                            <input
                                type="file"
                                id="video-upload"
                                class="hidden"
                                accept="video/*"
                            />
                        </div>
                    </div>

                    <!-- Object controls -->
                    <div
                        class="bg-[#2a2a2a] p-6 rounded-xl border border-white/5"
                    >
                        <h2
                            class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4"
                        >
                            Scene
                        </h2>
                        <div class="grid grid-cols-2 gap-3">
                            <button
                                id="btn-add-rect"
                                class="bg-gray-700 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm transition text-left flex items-center gap-2"
                            >
                                <span class="w-2 h-2 rounded-full bg-blue-400"
                                ></span> Add Rect
                            </button>
                            <button
                                id="btn-add-text"
                                class="bg-gray-700 hover:bg-purple-600 text-white px-3 py-2 rounded text-sm transition text-left flex items-center gap-2"
                            >
                                <span class="w-2 h-2 rounded-full bg-purple-400"
                                ></span> Add Text
                            </button>
                            <button
                                id="btn-add-chart"
                                class="col-span-2 bg-gray-700 hover:bg-emerald-600 text-white px-3 py-2 rounded text-sm transition text-left flex items-center gap-2"
                            >
                                <span
                                    class="w-2 h-2 rounded-full bg-emerald-400"
                                ></span> Add Chart
                            </button>
                            <button
                                id="btn-add-video"
                                class="col-span-2 bg-gray-700 hover:bg-orange-600 text-white px-3 py-2 rounded text-sm transition text-left flex items-center gap-2"
                            >
                                <span class="w-2 h-2 rounded-full bg-orange-400"
                                ></span> Import Video
                            </button>
                        </div>
                        <div
                            id="object-list"
                            class="mt-4 space-y-2 max-h-40 overflow-y-auto custom-scrollbar"
                        >
                            <!-- Items added here -->
                        </div>
                    </div>
                </div>

                <!-- Canvas Area -->
                <div class="lg:col-span-2">
                    <div
                        id="canvas-container"
                        class="relative aspect-video bg-black rounded-xl overflow-hidden shadow-2xl border border-white/10 ring-4 ring-black/20 flex justify-center items-center transition-colors"
                    >
                        <canvas id="engine-canvas" class="w-full h-full block"
                        ></canvas>

                        <!-- Loading Overlay -->
                        <div
                            id="loader"
                            class="absolute inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm z-10 hidden"
                        >
                            <div
                                class="w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"
                            >
                            </div>
                        </div>

                        <!-- Drag Overlay -->
                        <div
                            id="drag-overlay"
                            class="absolute inset-0 flex items-center justify-center bg-blue-500/20 backdrop-blur-sm z-30 hidden pointer-events-none border-4 border-blue-500 border-dashed m-4 rounded-xl"
                        >
                            <div class="text-blue-200 font-bold text-xl">
                                Drop Video Here
                            </div>
                        </div>
                    </div>

                    <!-- Code Preview -->
                    <div
                        class="mt-8 bg-[#151515] rounded-xl p-6 border border-white/5 font-mono text-sm"
                    >
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-500">Live Code Check</span>
                            <span
                                class="text-xs text-emerald-400 bg-emerald-400/10 px-2 py-1 rounded"
                                >@kinetix/core</span
                            >
                        </div>
                        <pre
                            class="text-gray-300 overflow-x-auto"><code id="code-preview">// Engine initializing...</code></pre>
                    </div>
                </div>

                <!-- Right Sidebar (Export & Inspector) -->
                <div class="space-y-6">
                    <!-- Export controls -->
                    <div
                        id="export-container"
                        class="bg-[#2a2a2a] p-6 rounded-xl border border-white/5"
                    >
                        <!-- Export Controls Mount -->
                    </div>

                    <!-- Inspector -->
                    <div
                        class="bg-[#2a2a2a] rounded-xl border border-white/5 h-[400px] flex flex-col overflow-hidden shadow-lg"
                    >
                        <div
                            id="inspector-container"
                            class="flex-1 overflow-hidden relative"
                        >
                            <!-- Inspector Mount -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        import {
            Engine,
            PlayerOverlay,
            VideoObject,
            CanvasControl,
            ExportControl,
            InspectorPanel,
            RichTextObject,
            ChartObject,
        } from "../open-source-engine/src/index.ts";
        import { KinetixObject } from "../open-source-engine/src/objects/Object.ts";

        // --- Custom Implementation for Demo ---
        class RectObject extends KinetixObject {
            color: string;
            constructor(id: string, color: string) {
                super(id, "Rect");
                this.color = color;
                this.width = 200;
                this.height = 200;
            }
            draw(ctx: CanvasRenderingContext2D, time: number) {
                ctx.fillStyle = this.color;
                const cx = this.x + this.width / 2;
                const cy = this.y + this.height / 2;

                ctx.translate(cx, cy);
                ctx.rotate((this.rotation * Math.PI) / 180);
                ctx.translate(-cx, -cy);

                ctx.globalAlpha = this.opacity;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
            clone() {
                return new RectObject("clone_" + this.id, this.color);
            }
            getSchema(): import("../open-source-engine/src/types/Interfaces").PropertySchema[] {
                return [
                    { key: "color", label: "Color", type: "color" },
                    ...super.getSchema(),
                ];
            }
        }

        // --- Initialization ---
        const canvas = document.getElementById(
            "engine-canvas",
        ) as HTMLCanvasElement;
        const canvasContainer =
            document.querySelector("#engine-canvas")?.parentElement;

        // Initialize Engine
        const engine = new Engine(canvas);

        // Expose to window for debug
        (window as any).engine = engine;

        const codePreview = document.getElementById("code-preview");

        // UI Components
        new PlayerOverlay(
            engine,
            document.getElementById("canvas-container") as HTMLElement,
        );
        new CanvasControl(
            engine,
            document.getElementById("settings-container") as HTMLElement,
        );
        new ExportControl(
            engine,
            document.getElementById("export-container") as HTMLElement,
        );
        new InspectorPanel(
            engine,
            document.getElementById("inspector-container") as HTMLElement,
        );

        // REMOVED: Auto-resize listener
        // window.addEventListener("resize", resize);

        document
            .getElementById("btn-add-rect")
            ?.addEventListener("click", () => {
                console.log("Adding Rect...");
                try {
                    const id = "rect_" + Date.now();
                    const rect = new RectObject(id, "#3b82f6");
                    // Center it roughly
                    rect.x = engine.scene.width / 2 - 100;
                    rect.y = engine.scene.height / 2 - 100;

                    engine.scene.add(rect);
                    updateCodePreview();
                    addToList(id, "Rectangle");
                    engine.interaction.selectObject(id);
                } catch (e) {
                    console.error(e);
                    alert("Error adding rect: " + e);
                }
            });

        document
            .getElementById("btn-add-text")
            ?.addEventListener("click", () => {
                console.log("Adding Text...");
                try {
                    const id = "text_" + Date.now();
                    // Use Real RichTextObject
                    const text = new RichTextObject(id, "Hello World");
                    text.x = engine.scene.width / 2 - 150;
                    text.y = engine.scene.height / 2;
                    text.fontSize = 60;

                    engine.scene.add(text);
                    updateCodePreview();
                    addToList(id, "Rich Text");
                    engine.interaction.selectObject(id);
                } catch (e) {
                    console.error(e);
                    alert("Error adding text: " + e);
                }
            });

        document
            .getElementById("btn-add-chart")
            ?.addEventListener("click", () => {
                console.log("Adding Chart...");
                try {
                    const id = "chart_" + Date.now();
                    const chart = new ChartObject(id, "bar");

                    // Center
                    chart.x = engine.scene.width / 2 - 200;
                    chart.y = engine.scene.height / 2 - 150;

                    engine.scene.add(chart);
                    updateCodePreview();
                    addToList(id, "Chart");
                    engine.interaction.selectObject(id);
                } catch (e) {
                    console.error(e);
                    alert("Error adding chart: " + e);
                }
            });

        document
            .getElementById("btn-add-video")
            ?.addEventListener("click", () => {
                document.getElementById("video-upload")?.click();
            });

        document
            .getElementById("video-upload")
            ?.addEventListener("change", (e) => {
                const file = (e.target as HTMLInputElement).files?.[0];
                if (!file) return;

                const url = URL.createObjectURL(file);
                console.log("Video selected:", file.name);

                try {
                    const id = "vid_" + Date.now();
                    const videoObj = new VideoObject(id, url);

                    // Center
                    videoObj.x = 0;
                    videoObj.y = 0;
                    videoObj.width = engine.scene.width;
                    videoObj.height = engine.scene.height;

                    engine.scene.add(videoObj);
                    updateCodePreview();
                    addToList(id, "Video");
                    engine.interaction.selectObject(id);
                } catch (e) {
                    console.error(e);
                    alert("Error adding video: " + e);
                }
            });

        // --- Save / Load ---
        document.getElementById("btn-save")?.addEventListener("click", () => {
            console.log("Saving Project...");
            try {
                const json = engine.project.save();
                const blob = new Blob([json], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "project.json";
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error("Save failed:", e);
                alert("Save failed: " + e);
            }
        });

        document.getElementById("btn-load")?.addEventListener("click", () => {
            console.log("Load clicked");
            document.getElementById("file-upload")?.click();
        });

        document
            .getElementById("file-upload")
            ?.addEventListener("change", (e) => {
                const file = (e.target as HTMLInputElement).files?.[0];
                if (!file) return;
                console.log("File selected", file.name);
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const json = ev.target?.result as string;
                    if (json) {
                        try {
                            engine.project.load(json);
                            updateCodePreview();
                            // Re-populate list
                            const list = document.getElementById("object-list");
                            if (list) list.innerHTML = "";
                            engine.scene.objects.forEach((obj) => {
                                addToList(obj.id, obj.constructor.name);
                            });
                            console.log("Project loaded");
                        } catch (e) {
                            console.error("Load failed:", e);
                            alert("Load failed or invalid JSON");
                        }
                    }
                };
                reader.readAsText(file);
            });

        function updateCodePreview() {
            if (!codePreview) return;
            const lines = [
                `const engine = new Engine(canvas);`,
                `engine.resize(${engine.scene.width}, ${engine.scene.height});`,
            ];
            engine.scene.objects.forEach((obj) => {
                lines.push(
                    `engine.scene.add(new ${obj.name}("${obj.id}")); // x:${obj.x.toFixed(0)}, y:${obj.y.toFixed(0)}`,
                );
            });
            codePreview.innerText = lines.join("\n");
        }

        function addToList(id: string, label: string) {
            const list = document.getElementById("object-list");
            if (!list) return;
            const el = document.createElement("div");
            el.className =
                "flex justify-between items-center bg-black/20 p-2 rounded text-xs text-gray-300";
            el.innerHTML = `<span>${label}</span> <span class="text-gray-600 font-mono">${id.slice(-4)}</span>`;
            list.appendChild(el);
        }

        // Start
        updateCodePreview();

        // --- Drag & Drop ---
        const dragOverlay = document.getElementById("drag-overlay");

        if (canvasContainer) {
            canvasContainer.addEventListener("dragenter", (e) => {
                e.preventDefault();
                dragOverlay?.classList.remove("hidden");
            });

            canvasContainer.addEventListener("dragover", (e) => {
                e.preventDefault();
            });

            canvasContainer.addEventListener("dragleave", (e) => {
                e.preventDefault();
                // Simple check to ensure we left the container
                if (
                    e.relatedTarget &&
                    canvasContainer.contains(e.relatedTarget as Node)
                )
                    return;
                dragOverlay?.classList.add("hidden");
            });

            canvasContainer.addEventListener("drop", (e) => {
                e.preventDefault();
                dragOverlay?.classList.add("hidden");

                const files = e.dataTransfer?.files;
                if (!files || files.length === 0) return;

                const file = files[0];
                if (file.type.startsWith("video/")) {
                    const url = URL.createObjectURL(file);
                    const id = "vid_" + Date.now();
                    const videoObj = new VideoObject(id, url);

                    // Center
                    videoObj.x = 0;
                    videoObj.y = 0;
                    videoObj.width = engine.scene.width;
                    videoObj.height = engine.scene.height;

                    engine.scene.add(videoObj);
                    updateCodePreview();
                    addToList(id, "Video");
                } else {
                    alert("Please drop a video file.");
                }
            });
        }
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        /* Ensure canvas fits visually but maintains aspect ratio */
        #engine-canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            width: auto;
            height: auto;
        }
    </style>
</Layout>
