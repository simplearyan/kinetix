---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Video Export Demo">
    <main
        class="min-h-screen bg-gray-900 text-white flex flex-col items-center justify-center p-8"
    >
        <div class="max-w-4xl w-full space-y-8">
            <header class="text-center space-y-2">
                <h1
                    class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400"
                >
                    Canvas Video Export
                </h1>
                <p class="text-gray-400">
                    High-fidelity 60FPS rendering & export
                </p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Controls -->
                <div
                    class="bg-gray-800 p-6 rounded-xl border border-gray-700 space-y-6"
                >
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-300"
                            >Resolution</label
                        >
                        <select
                            id="resolution"
                            class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none"
                        >
                            <option value="1280x720">HD (720p)</option>
                            <option value="1920x1080" selected
                                >Full HD (1080p)</option
                            >
                            <option value="3840x2160">4K (2160p)</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-300"
                            >Duration</label
                        >
                        <div class="flex items-center gap-4">
                            <input
                                type="range"
                                id="duration"
                                min="2"
                                max="10"
                                value="3"
                                class="flex-1 accent-blue-500"
                            />
                            <span
                                id="duration-val"
                                class="text-mono w-12 text-right">3s</span
                            >
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-300"
                            >Format</label
                        >
                        <select
                            id="format"
                            class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none"
                        >
                            <option value="video/webm; codecs=vp9"
                                >WebM (VP9 - Best Quality)</option
                            >
                            <option value="video/mp4"
                                >MP4 (H.264 - Best Compat)</option
                            >
                        </select>
                    </div>

                    <div class="pt-4 border-t border-gray-700">
                        <button
                            id="export-btn"
                            class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg shadow-blue-900/20 transition-all flex items-center justify-center gap-2 group"
                        >
                            <span
                                class="group-hover:scale-105 transition-transform"
                                >Start Export</span
                            >
                            <svg
                                class="w-5 h-5 animate-spin hidden"
                                id="spinner"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <circle
                                    class="opacity-25"
                                    cx="12"
                                    cy="12"
                                    r="10"
                                    stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path
                                    class="opacity-75"
                                    fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                ></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Progress Bar -->
                    <div id="progress-container" class="hidden space-y-2 pt-4">
                        <div class="flex justify-between text-xs text-gray-400">
                            <span>Rendering...</span>
                            <span id="progress-text">0%</span>
                        </div>
                        <div
                            class="h-2 bg-gray-700 rounded-full overflow-hidden"
                        >
                            <div
                                id="progress-bar"
                                class="h-full bg-blue-500 w-0 transition-all duration-75 ease-out"
                            >
                            </div>
                        </div>
                    </div>

                    <div
                        id="download-area"
                        class="hidden pt-4 border-t border-gray-700 text-center animate-fade-in"
                    >
                        <p class="text-green-400 text-sm mb-2">
                            Rendering Complete!
                        </p>
                        <a
                            id="download-link"
                            class="inline-block w-full py-2.5 bg-emerald-600 hover:bg-emerald-500 text-white font-medium rounded-lg transition-colors cursor-pointer"
                        >
                            Download Video
                        </a>
                    </div>
                </div>

                <!-- Preview -->
                <div
                    class="lg:col-span-2 bg-black rounded-xl overflow-hidden border border-gray-700 shadow-2xl relative flex items-center justify-center"
                >
                    <div
                        class="absolute inset-0 grid grid-cols-[repeat(20,minmax(0,1fr))] grid-rows-[repeat(20,minmax(0,1fr))] opacity-20 pointer-events-none"
                    >
                        <!-- Simple grid background -->
                        {
                            Array.from({ length: 400 }).map(() => (
                                <div class="border-[0.5px] border-gray-500" />
                            ))
                        }
                    </div>

                    <!-- The Canvas -->
                    <!-- We display it scaled down with CSS, but the internal resolution will be high -->
                    <canvas
                        id="canvas"
                        class="max-w-full max-h-full aspect-video shadow-2xl"
                    ></canvas>

                    <div
                        class="absolute bottom-4 right-4 bg-black/70 backdrop-blur-md px-3 py-1 rounded-md text-xs font-mono text-gray-300 pointer-events-none"
                    >
                        <span id="res-display">1920x1080</span> @ 60FPS
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    import { VideoRecorder } from "../utils/video-recorder";

    const canvas = document.getElementById("canvas") as HTMLCanvasElement;
    const ctx = canvas.getContext("2d")!;

    // UI Elements
    const resolutionSelect = document.getElementById(
        "resolution",
    ) as HTMLSelectElement;
    const formatSelect = document.getElementById("format") as HTMLSelectElement;
    const exportBtn = document.getElementById(
        "export-btn",
    ) as HTMLButtonElement;
    const spinner = document.getElementById("spinner") as HTMLElement;
    const downloadArea = document.getElementById(
        "download-area",
    ) as HTMLElement;
    const downloadLink = document.getElementById(
        "download-link",
    ) as HTMLAnchorElement;
    const resDisplay = document.getElementById("res-display") as HTMLElement;
    const durationInput = document.getElementById(
        "duration",
    ) as HTMLInputElement;
    const durationVal = document.getElementById("duration-val") as HTMLElement;

    let animationId: number;
    let isRecording = false;
    let time = 0;

    // Configuration
    const getConfig = () => {
        const [w, h] = resolutionSelect.value.split("x").map(Number);
        return {
            width: w,
            height: h,
            duration: parseInt(durationInput.value) * 1000,
            mimeType: formatSelect.value,
        };
    };

    // Resize canvas logic
    const resizeCanvas = () => {
        const { width, height } = getConfig();
        canvas.width = width;
        canvas.height = height;
        resDisplay.textContent = `${width}x${height}`;
    };

    // Animation Loop
    const draw = (dt: number) => {
        const { width, height } = canvas;
        const t = isRecording ? time : performance.now(); // If recording, we use deterministic time

        // Clear
        ctx.fillStyle = "#0f172a"; // Slate-900
        ctx.fillRect(0, 0, width, height);

        // Draw Grid (Animated)
        ctx.strokeStyle = "#1e293b";
        ctx.lineWidth = 2;
        const gridSize = 100;
        const offset = (t * 0.1) % gridSize;

        ctx.beginPath();
        for (let x = 0; x <= width + gridSize; x += gridSize) {
            ctx.moveTo(x - offset, 0);
            ctx.lineTo(x - offset, height);
        }
        ctx.stroke();

        // Draw Rotating Elements
        const centerX = width / 2;
        const centerY = height / 2;

        // 1. Orbiting Circles
        const radius = Math.min(width, height) * 0.3;
        const orbs = 5;

        for (let i = 0; i < orbs; i++) {
            const angle = t * 0.002 + i * ((Math.PI * 2) / orbs);
            const x = centerX + Math.cos(angle) * radius;
            const y = centerY + Math.sin(angle) * radius;

            ctx.fillStyle = `hsl(${(t * 0.1 + i * 60) % 360}, 70%, 60%)`;
            ctx.beginPath();
            ctx.arc(x, y, 40, 0, Math.PI * 2);
            ctx.fill();

            // Glow
            ctx.shadowColor = `hsl(${(t * 0.1 + i * 60) % 360}, 70%, 60%)`;
            ctx.shadowBlur = 30;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            ctx.fill();
            ctx.shadowBlur = 0; // Reset
        }

        // 2. Central Text
        ctx.save();
        ctx.translate(centerX, centerY);
        const scale = 1 + Math.sin(t * 0.005) * 0.1;
        ctx.scale(scale, scale);

        ctx.font = `bold ${height * 0.1}px Inter, system-ui, sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillStyle = "#ffffff";
        ctx.fillText("KINETIX", 0, 0);

        ctx.font = `bold ${height * 0.03}px monospace`;
        ctx.fillStyle = "#94a3b8";
        ctx.fillText(new Date().toLocaleTimeString(), 0, height * 0.08);

        ctx.restore();

        // Progress bar (only when recording)
    };

    // Interactive Loop (runs when NOT recording)
    const startInteractiveLoop = () => {
        const loop = (timestamp: number) => {
            if (!isRecording) {
                draw(timestamp);
                animationId = requestAnimationFrame(loop);
            }
        };
        animationId = requestAnimationFrame(loop);
    };

    // Recording Logic
    const startExport = async () => {
        if (isRecording) return;
        isRecording = true;

        // UI Updates
        exportBtn.disabled = true;
        exportBtn.classList.add("opacity-75", "cursor-not-allowed");
        spinner.classList.remove("hidden");
        downloadArea.classList.add("hidden");

        const config = getConfig();

        // 1. Resize for high-res
        resizeCanvas();

        // 2. Init Recorder
        const recorder = new VideoRecorder(canvas, {
            fps: 60,
            videoBitsPerSecond: 16000000, // 16 Mbps
            mimeType: config.mimeType,
        });

        try {
            recorder.start();

            const FPS = 60;
            const duration = config.duration;
            const totalFrames = (duration / 1000) * FPS;
            const msPerFrame = 1000 / FPS;

            // 3. Render Loop (Synchronous-ish)
            time = 0;
            for (let i = 0; i < totalFrames; i++) {
                time += msPerFrame;
                draw(time);
                await new Promise((r) => setTimeout(r, 0));
            }

            // 4. Finish
            const url = await recorder.stop();

            downloadLink.href = url;
            const ext = config.mimeType.includes("mp4") ? "mp4" : "webm";
            downloadLink.download = `kinetix-export-${Date.now()}.${ext}`;
            downloadArea.classList.remove("hidden");
        } catch (e) {
            console.error(e);
            alert("Export failed. See console.");
        } finally {
            isRecording = false;
            exportBtn.disabled = false;
            exportBtn.classList.remove("opacity-75", "cursor-not-allowed");
            spinner.classList.add("hidden");

            // Resume interactive preview
            startInteractiveLoop();
        }
    };

    // Listeners
    resolutionSelect.addEventListener("change", resizeCanvas);

    durationInput.addEventListener("input", (e) => {
        durationVal.textContent = `${(e.target as HTMLInputElement).value}s`;
    });

    exportBtn.addEventListener("click", startExport);

    // Init
    resizeCanvas();
    startInteractiveLoop();
</script>
